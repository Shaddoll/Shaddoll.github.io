<!DOCTYPE html>
<html>
    <head>
		<meta charset='utf-8'>
		<title>abc</title>
    </head>
    <body>
		<div style = "width:80%; margin: 0px auto">
			<canvas id = "showwindow" height = "500" style = "width:100%;border: solid 2px #CCCCCC">
			</canvas>
		</div>
        <div style="width:80%; margin:auto">
            A:放大，B:缩小，上下左右方向键控制视角移动
        </div>
    </body>
</html>

<script language = "javascript">
//----设置全局变量
var timedelay = 100;
var length = 8;             //细胞边长20px
var c_width = 700;            //画布宽高
var c_height = 500;
var c_offset_x = 0;           //相对于大地图的细胞位置数偏移
var c_offset_y = 0;
var mapsize = 100;
//map 数据
var map = new Array();        //大地图
for(var i = 0; i < mapsize; i++){
    map[i]=new Array();
    for(var j = 0; j < mapsize; j++){
        map[i][j] = 0;
    }
}
var newmap = new Array();        //大地图
for(var i = 0; i < mapsize; i++){
    newmap[i]=new Array();
    for(var j = 0; j < mapsize; j++) {
        newmap[i][j] = 0;
    }
}
//---map[i][j] = 0 死
//---map[i][j] = 1 活

//----设置全局变量完毕
init();
timer = setInterval(loop, timedelay);
function init(){
	document.getElementById("showwindow").width = c_width;
	document.getElementById("showwindow").height = c_height;
	var i, j;                              //随机生成活细胞
	for (i = 0; i < mapsize; i++){
		for (j = 0; j < mapsize; j++){
			if (Math.random() > 0.95){
				map[i][j] = 1;
			}
		}
	}
	return;
}
//绘图
function draw(i, j, k){       //在地图（i，j）的位置画一个状态为k的细胞
	if (k == 0)
		return;
	if (i*length < 0 || (i+1)*length > c_width || j*length < 0 || (j+1)*length > c_height)
		return;
	var can = document.getElementById("showwindow");
	cans = can.getContext('2d');
	cans.beginPath();
	cans.arc((i+0.5)*length, (j+0.5)*length, length*0.45, 0, Math.PI*2, true);
	cans.closePath();
	cans.fillStyle = 'green';
	cans.fill();
}
function clearcanvas(){
	var can = document.getElementById("showwindow");
	cans = can.getContext('2d');
	cans.fillStyle="#FFFFFF";
	cans.fillRect(0, 0, c_width, c_height);
	return;
}
function drawmap(){
	var i, j;
	clearcanvas();
	for (i = c_offset_x; i < c_offset_x + c_width/length + 1; i++){
		for (j = c_offset_y; j < c_offset_y + c_height/length + 1; j++){
		    draw((i - c_offset_x + mapsize) % mapsize, (j - c_offset_y + mapsize) % mapsize, map[i%mapsize][j%mapsize]);
		}
	}
}
//逻辑上产生下一代
function nextgeneration(){
	var i, j, k;
	for (i = 0; i < mapsize; i++){
		for (j = 0; j < mapsize; j++){
			k = map[(i-1+mapsize)%mapsize][j] + map[(i+1)%mapsize][j] + map[i][(j-1+mapsize)%mapsize] + map[i][(j+1)%mapsize] + map[(i-1+mapsize)%mapsize][(j-1+mapsize)%mapsize] + map[(i-1+mapsize)%mapsize][(j+1)%mapsize] + map[(i+1)%mapsize][(j-1+mapsize)%mapsize] + map[(i+1)%mapsize][(j+1)%mapsize];
			if (k == 3)
				newmap[i][j] = 1;
			else if (k == 2)
				newmap[i][j] = map[i][j];
			else
                newmap[i][j] = 0;
		}
	}
	for (i = 0; i < mapsize; i++){
		for (j = 0; j < mapsize; j++){
			map[i][j] = newmap[i][j];
		}
	}
}
//循环
function loop(){
    var mydate = new Date().getTime();
	nextgeneration();
    console.log(new Date().getTime() - mydate);
	drawmap();
}
//控制地图
function bigger(){
	length += 2;
	return;
}
function smaller(){
	if (length - 2 >= 4)
		length -= 2;
	return;
}
function goleft(){
	c_offset_x = (c_offset_x - parseInt(40/length) + mapsize) % mapsize;
}

function goright(){
	c_offset_x = (c_offset_x + parseInt(40/length) + mapsize) % mapsize;
}

function godown(){
	c_offset_y = (c_offset_y + parseInt(40/length) + mapsize) % mapsize;
}

function goup(){
	c_offset_y = (c_offset_y - parseInt(40/length) + mapsize) % mapsize;
}
//----键盘响应函数 上下左右ab键
document.onkeydown=function(event){
var e = event || window.event || arguments.callee.caller.arguments[0];
if(e && e.keyCode==65){//A
	bigger();
}
if(e && e.keyCode==66){//B
	smaller();
} 
if(e && e.keyCode==38){// UP
	goup();
}
if(e && e.keyCode==40){//DOWN
	godown();
}
if(e && e.keyCode==37){//LEFT
	goleft();
}
if(e && e.keyCode==39){//RIGHT
	goright();
}
};
document.addEventListener("gesturestart", function (e) {
    startscale = e.scale;
}, false);
document.addEventListener("gesturechange", function (e) {
    if (e.scale > startscale)
        bigger();
    else
        smaller();
    startscale = e.scale;
}, false);
//----键盘响应函数---END
</script>
